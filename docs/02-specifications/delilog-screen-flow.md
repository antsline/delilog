# delilog 画面遷移図・フロー図

## 1. 全体画面構成

```mermaid
graph TB
    subgraph "起動フロー"
        A[スプラッシュ画面] --> B{認証状態確認}
        B -->|未認証| C[ログイン画面]
        B -->|認証済み| D[ホーム画面]
    end

    subgraph "認証フロー"
        C --> E[新規登録画面]
        C --> F[パスワードリセット]
        E --> G[車両登録画面]
        G --> D
    end

    subgraph "メインアプリ"
        D --> H[業務前点呼]
        D --> I[業務後点呼]
        D --> J[記録一覧]
        D --> K[設定]

        J --> L[PDF出力]
        J --> M[記録詳細/編集]

        K --> N[プロフィール編集]
        K --> O[車両管理]
        K --> P[通知設定]
        K --> Q[サブスクリプション]
    end
```

## 2. 認証フロー詳細

### 2.1 ログインフロー

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant A as アプリ
    participant S as Supabase
    participant G as Google/Apple

    U->>A: アプリ起動
    A->>S: セッション確認

    alt セッションなし
        S-->>A: 未認証
        A->>U: ログイン画面表示

        alt メール認証
            U->>A: メール/パスワード入力
            A->>S: signInWithPassword
            S-->>A: 認証成功/失敗
        else OAuth認証
            U->>A: Google/Appleボタン
            A->>G: OAuth認証開始
            G-->>A: 認証情報
            A->>S: signInWithOAuth
            S-->>A: 認証成功/失敗
        else SMS認証
            U->>A: 電話番号入力
            A->>S: signInWithOtp
            S->>U: SMS送信
            U->>A: OTP入力
            A->>S: verifyOtp
            S-->>A: 認証成功/失敗
        end

        A->>U: ホーム画面遷移
    else セッションあり
        S-->>A: 認証済み
        A->>U: ホーム画面表示
    end
```

### 2.2 新規登録フロー

```mermaid
flowchart TD
    A[ログイン画面] --> B[新規登録ボタン]
    B --> C[登録方法選択]

    C --> D[メール登録]
    C --> E[Google登録]
    C --> F[Apple登録]

    D --> G[基本情報入力画面]
    E --> G
    F --> G

    G --> H{入力検証}
    H -->|不正| I[エラー表示]
    I --> G

    H -->|正常| J[車両情報入力]
    J --> K{車両検証}
    K -->|不正| L[エラー表示]
    L --> J

    K -->|正常| M[登録完了]
    M --> N[ホーム画面]
```

## 3. 点呼記録フロー

### 3.1 業務前点呼フロー

```mermaid
stateDiagram-v2
    [*] --> ホーム画面
    ホーム画面 --> 業務前点呼: ボタンタップ

    state 業務前点呼 {
        [*] --> 初期表示
        初期表示 --> 車両選択: デフォルト値セット
        車両選択 --> アルコール入力
        アルコール入力 --> 健康状態選択
        健康状態選択 --> 日常点検確認
        日常点検確認 --> 特記事項入力
        特記事項入力 --> 確認画面

        確認画面 --> 保存処理: 保存ボタン
        保存処理 --> [*]: 成功
        保存処理 --> エラー表示: 失敗
        エラー表示 --> 確認画面: 再試行
    }

    業務前点呼 --> ホーム画面: 完了/キャンセル
```

### 3.2 業務後点呼フロー

```mermaid
stateDiagram-v2
    [*] --> ホーム画面
    ホーム画面 --> 業務後点呼: ボタンタップ

    state 業務後点呼 {
        [*] --> 初期表示
        初期表示 --> 車両確認: 業務前と同じ車両
        車両確認 --> アルコール入力
        アルコール入力 --> 運行状況選択
        運行状況選択 --> 特記事項入力
        特記事項入力 --> 確認画面

        確認画面 --> 保存処理: 保存ボタン
        保存処理 --> [*]: 成功
        保存処理 --> エラー表示: 失敗
        エラー表示 --> 確認画面: 再試行
    }

    業務後点呼 --> ホーム画面: 完了/キャンセル
```

## 4. 記録管理フロー

### 4.1 記録一覧・編集フロー

```mermaid
flowchart TD
    A[記録一覧タブ] --> B[月選択]
    B --> C[日別カード表示]

    C --> D{記録状態}
    D -->|完了| E[緑チェック表示]
    D -->|一部未完了| F[黄色警告表示]
    D -->|運行なし| G[グレー表示]

    C --> H[カードタップ]
    H --> I[記録詳細画面]

    I --> J{編集可能期間?}
    J -->|24時間以内| K[編集ボタン表示]
    J -->|24時間超過| L[閲覧のみ]

    K --> M[編集画面]
    M --> N[保存]
    N --> C
```

### 4.2 PDF出力フロー

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant A as アプリ
    participant P as PDFGenerator
    participant S as Storage

    U->>A: PDF出力ボタン
    A->>A: 週選択ダイアログ
    U->>A: 週を選択

    A->>P: 週データ送信
    P->>P: PDF生成処理
    P-->>A: PDF Blob

    A->>U: プレビュー表示

    alt 保存
        U->>A: 保存ボタン
        A->>S: PDFファイル保存
        S-->>A: 保存完了
        A->>U: 成功通知
    else 共有
        U->>A: 共有ボタン
        A->>A: シェアシート表示
        U->>A: 共有先選択
    else 印刷
        U->>A: コンビニ印刷
        A->>U: 手順説明画面
    end
```

## 5. 設定・管理フロー

### 5.1 車両管理フロー

```mermaid
stateDiagram-v2
    [*] --> 車両一覧

    車両一覧 --> 新規追加: +ボタン
    車両一覧 --> 編集: 車両タップ

    state 新規追加 {
        [*] --> ナンバー入力
        ナンバー入力 --> 車両名入力
        車両名入力 --> デフォルト設定
        デフォルト設定 --> 保存
        保存 --> [*]
    }

    state 編集 {
        [*] --> 情報変更
        情報変更 --> 保存/削除
        保存/削除 --> [*]
    }

    新規追加 --> 車両一覧: 完了
    編集 --> 車両一覧: 完了

    車両一覧 --> [*]: 戻る
```

### 5.2 サブスクリプション管理フロー

```mermaid
flowchart TD
    A[設定画面] --> B[サブスクリプション]

    B --> C{現在のプラン}

    C -->|ベーシック| D[プロプラン案内]
    D --> E[アップグレード画面]
    E --> F[App Store決済]
    F --> G[決済完了]
    G --> H[プロプラン有効化]

    C -->|プロ| I[プラン詳細表示]
    I --> J[解約オプション]
    J --> K[解約確認]
    K --> L[App Store設定]

    C -->|トライアル| M[残り日数表示]
    M --> E
```

## 6. オフライン時のフロー

### 6.1 オフライン検知と処理

```mermaid
flowchart TD
    A[アプリ操作] --> B{ネットワーク状態}

    B -->|オンライン| C[通常処理]
    C --> D[Supabase同期]
    D --> E[完了]

    B -->|オフライン| F[オフライン通知]
    F --> G[ローカル保存]
    G --> H[キューに追加]
    H --> I[操作継続可能]

    I --> J{ネットワーク復帰}
    J -->|復帰| K[自動同期開始]
    K --> L[キュー処理]
    L --> M[同期完了通知]

    J -->|継続オフライン| N[ローカル動作継続]
```

## 7. エラーハンドリングフロー

### 7.1 エラー発生時の処理

```mermaid
flowchart TD
    A[エラー発生] --> B{エラータイプ}

    B -->|ネットワーク| C[オフライン処理へ]
    B -->|認証| D[再ログイン促す]
    B -->|バリデーション| E[エラー箇所表示]
    B -->|ビジネスロジック| F[エラーメッセージ]
    B -->|不明| G[一般エラー画面]

    C --> H[リトライオプション]
    D --> I[ログイン画面へ]
    E --> J[修正を促す]
    F --> K[対処法を表示]
    G --> L[サポート案内]

    H --> M{リトライ}
    M -->|成功| N[通常フローへ]
    M -->|失敗| O[エラー継続]
```

## 8. ナビゲーション構造

### 8.1 タブナビゲーション

```
┌─────────────────────────────────┐
│          Header                 │
├─────────────────────────────────┤
│                                 │
│          Content                │
│                                 │
├─────────────────────────────────┤
│  Home │ Records │ Settings     │
└─────────────────────────────────┘

タブ構成:
- Home: ホーム画面（点呼ボタン、今日の状態）
- Records: 記録一覧（カレンダー表示）
- Settings: 設定（プロフィール、車両、通知等）
```

### 8.2 モーダル・ボトムシート

```
使用箇所:
- 週選択（PDF出力時）: ボトムシート
- 確認ダイアログ: モーダル
- エラー表示: トースト/スナックバー
- 車両選択: ボトムシート
- 日付選択: ネイティブピッカー
```

## 9. 状態遷移のルール

### 9.1 画面遷移の制約

1. **認証必須画面**
   - ホーム画面以降はすべて認証必須
   - 未認証時は自動的にログイン画面へ

2. **戻る操作の制限**
   - 登録完了後はログイン画面に戻れない
   - 点呼記録中は確認ダイアログ表示

3. **重複防止**
   - 同日同種の点呼は作成不可
   - 重複時は既存記録の編集へ誘導

4. **時間制約**
   - 記録の編集は24時間以内のみ
   - 削除も同様の制約

### 9.2 データ整合性の保証

```mermaid
flowchart LR
    A[ユーザー操作] --> B[楽観的更新]
    B --> C[ローカル状態更新]
    C --> D[UI即座反映]

    B --> E[API呼び出し]
    E --> F{成功?}
    F -->|Yes| G[確定]
    F -->|No| H[ロールバック]
    H --> I[エラー表示]
    H --> C
```
