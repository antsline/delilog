# Week 3: アルコール検知項目の設計決定

## 概要
Week 3の業務前点呼フォーム実装において、アルコール検知関連項目の設計について重要な決定を行った。

## 背景

### 当初の要件定義
delilog-requirements.mdに記載された業務前点呼の項目：
- アルコール検知器使用（有/無）
- 酒気帯びの有無（デフォルト：無、数値入力 0.00）
- アルコール数値入力

### ユーザビリティの課題
1. **冗長性**: アルコール数値があれば検知器使用と酒気帯びの有無は自動判定可能
2. **入力ミス**: 手動選択と数値入力で矛盾が生じる可能性
3. **入力効率**: 毎日の操作での手間を最小化したい

## 設計決定内容

### 1. 入力フォームの簡素化
**決定**: アルコール数値入力のみをユーザーに求める

**理由**:
- 論理的整合性：数値 > 0.00 = 検知器使用 & 酒気帯びあり
- UX向上：入力項目の削減
- データ整合性：矛盾する入力の防止

### 2. 自動判定ロジック
```typescript
// フォーム送信時の自動判定
const alcoholDetectorUsed = parseFloat(data.alcoholLevel) > 0.00;
const alcoholDetected = parseFloat(data.alcoholLevel) > 0.00;
```

### 3. データベース保存
**保存内容**:
- `alcohol_level`: ユーザー入力値
- `alcohol_detector_used`: 自動判定結果
- `alcohol_detected`: 自動判定結果

### 4. 法的要件への対応
**PDF出力時の表示**:
- 「アルコール検知器使用」：自動判定結果を明記
- 「酒気帯びの有無」：自動判定結果を明記
- 「アルコール数値」：入力値をそのまま表示

## 法的根拠と業界慣行

### 運送業における点呼記録の法的要求
1. **道路交通法**: 酒気帯び運転の防止
2. **貨物自動車運送事業法**: 点呼の実施義務
3. **国土交通省指導**: アルコール検知器の使用推奨

### 記録様式での必要項目
監査や検査では以下の項目の記録が確認される：
- アルコール検知器使用の有無
- 酒気帯びの有無
- 具体的な数値（使用時）

## 技術的実装

### フロントエンド
```typescript
// バリデーションスキーマ（簡素化後）
export const tenkoBeforeSchema = z.object({
  alcoholLevel: z.string()
    .regex(/^\d+(\.\d{1,2})?$/, 'アルコール数値は数字で入力してください')
    .refine((val) => parseFloat(val) >= 0 && parseFloat(val) <= 10),
  // alcohol_detector_used, alcohol_detected は除外
});
```

### バックエンド保存時
```typescript
const tenkoData = {
  alcohol_level: parseFloat(data.alcoholLevel),
  alcohol_detector_used: parseFloat(data.alcoholLevel) > 0.00,
  alcohol_detected: parseFloat(data.alcoholLevel) > 0.00,
  // その他のフィールド
};
```

### PDF生成時（将来実装）
```typescript
// PDF出力時に自動判定結果を表示
const pdfData = {
  alcoholDetectorUsed: record.alcohol_detector_used ? '使用' : '未使用',
  alcoholDetected: record.alcohol_detected ? '有' : '無',
  alcoholLevel: record.alcohol_level,
};
```

## 利点とリスク

### 利点
1. **UX大幅向上**: 入力項目の削減
2. **データ整合性**: 自動判定による矛盾防止
3. **保守性**: ロジックの一元化
4. **法的対応**: PDF出力で要求項目を満たす

### 潜在的リスク
1. **監査対応**: 「なぜ明示的な記録がないのか」の説明が必要
2. **業界慣行**: 他社との記録様式の違い
3. **法解釈**: 明示的記録を求める解釈の可能性

### リスク軽減策
1. **PDF出力での補完**: 法的書類では全項目を明記
2. **データベース設計**: 判定ロジックの透明性確保
3. **設定オプション**: 将来的に「詳細入力モード」の追加可能
4. **ドキュメント化**: 判定ロジックの明文化

## 今後の対応方針

### Phase 1（現在）: 簡素化実装
- アルコール数値のみの入力
- 自動判定による補完
- PDF出力での法的要件満足

### Phase 2（必要に応じて）: オプション追加
- 設定画面での「詳細入力モード」
- 企業要件に応じた切り替え
- 個別カスタマイズ対応

### Phase 3（将来）: 業界標準対応
- 業界団体や監督官庁との協議
- 標準的な記録様式の確立
- 他社事例の調査と対応

## 承認とレビュー

**決定日**: 2025年7月5日
**決定者**: プロダクトオーナー
**技術レビュー**: 完了
**法的確認**: PDF出力時の対応で充足と判断

**次回レビュー**: Week 6のPDF生成機能実装時に法的要件の最終確認を実施